<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Card Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
      @keyframes throwCard {
        from {
          transform: translateY(20px) scale(0.9);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }
      .animate-throw {
        animation: throwCard 0.3s ease-out;
      }
    </style>
  </head>

  <body class="bg-green-100 min-h-screen flex flex-col justify-between items-center p-6">

    <!-- TOP PLAYER -->
    <div class="text-center mb-4">
      <h2 class="font-bold">
        Opponent: <span id="topName">Waiting...</span>
      </h2>
      <p>Status: <span id="topStatus">-</span></p>
      <p>Score: <span id="topScore">0</span></p>
    </div>

    <!-- CENTER -->
    <div id="centerPile" class="bg-white p-6 rounded shadow w-full max-w-xl text-center">
      <h2 class="font-bold mb-1">Center Pile</h2>
      <p class="text-sm mb-2">
        Trump: <span id="trumpSuit" class="font-bold">-</span>
      </p>

      <div id="centerMessage" class="h-8 mb-2"></div>

      <div id="cards" class="flex justify-center gap-4"></div>
    </div>

    <!-- BOTTOM PLAYER -->
    <div class="text-center mt-4">
      <h2 class="font-bold">
        You: <span id="bottomName">Loading...</span>
      </h2>
      <p>Status: <span id="bottomStatus">-</span></p>
      <p>Score: <span id="bottomScore">0</span></p>

      <div id="hand" class="flex justify-center gap-2 mt-3"></div>
    </div>

    <script>
      const socket = io("http://localhost:30106", { withCredentials: true });

      const roomId = window.location.pathname.split("/").pop();
      const userId = "<%= user._id %>";

      socket.emit("joinRoom", { roomId, userId });

      /* =====================
         UI HELPERS
      ====================== */

      function showCenterMessage(text, color) {
        const el = document.getElementById("centerMessage");
        el.innerHTML = `<div class="font-bold text-${color}-600 animate-pulse">${text}</div>`;
        setTimeout(() => (el.innerHTML = ""), 1200);
      }

      function renderCard(card, disabled = false) {
        const el = document.createElement("div");
        el.className =
          "bg-white p-2 rounded border shadow cursor-pointer transition";

        if (disabled) {
          el.classList.add("opacity-50", "pointer-events-none");
        } else {
          el.classList.add("hover:bg-gray-100");
        }

        el.innerText = `${card.rank}${card.suit}`;
        return el;
      }

      /* =====================
         ROOM STATE
      ====================== */

      socket.on("roomState", (room) => {
        const players = room.players || [];
        const me = players.find(p => p.userId === userId) || {};
        const opponent = players.find(p => p.userId !== userId) || {};

        document.getElementById("topName").innerText = opponent.name || "Waiting";
        document.getElementById("topStatus").innerText = opponent.status || "-";
        document.getElementById("topScore").innerText = opponent.score || 0;

        document.getElementById("bottomName").innerText = me.name || "You";
        document.getElementById("bottomStatus").innerText = me.status || "-";
        document.getElementById("bottomScore").innerText = me.score || 0;

        document.getElementById("trumpSuit").innerText = room.trumpSuit || "-";

        /* CENTER PILE */
        const cardsDiv = document.getElementById("cards");
        cardsDiv.innerHTML = "";

        room.centerPile.forEach(c => {
          const cardEl = document.createElement("div");
          cardEl.className = "bg-gray-200 p-3 rounded border animate-throw";
          cardEl.innerText = `${c.rank}${c.suit}`;
          cardsDiv.appendChild(cardEl);
        });

        /* HAND */
        const handDiv = document.getElementById("hand");
        handDiv.innerHTML = "";

        const myTurn = room.turn === userId;

        me.hand?.forEach(card => {
          const cardEl = renderCard(card, !myTurn);
          cardEl.onclick = () => {
            socket.emit("playCard", { roomId, userId, card });
          };
          handDiv.appendChild(cardEl);
        });
      });

      /* =====================
         ROUND EVENTS
      ====================== */

      socket.on("roundTie", () => {
        showCenterMessage("Tie! Replay round", "yellow");
      });

      socket.on("roundWin", ({ winnerId }) => {
        if (winnerId === userId) {
          showCenterMessage("You won the round!", "green");
        } else {
          showCenterMessage("You lost the round", "red");
        }
      });

      socket.on("gameOver", ({ winner, isDraw }) => {
        if (isDraw) {
          showCenterMessage("Game Draw!", "gray");
        } else if (winner === userId) {
          showCenterMessage("You won the game ðŸŽ‰", "green");
        } else {
          showCenterMessage("You lost the game ðŸ˜¢", "red");
        }
      });

      socket.on("error", (err) => {
        alert(err.message || "Socket error");
      });
    </script>
  </body>
</html>
