<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Card Game</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    @keyframes throwFromBottom {
      from { transform: translateY(200px) scale(1.1); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    @keyframes throwFromTop {
      from { transform: translateY(-200px) scale(1.1); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .throw-bottom { animation: throwFromBottom 0.35s ease-out; }
    .throw-top { animation: throwFromTop 0.35s ease-out; }
  </style>
</head>

<body class="bg-green-100 min-h-screen flex flex-col justify-between items-center p-6">

  <!-- TOP PLAYER -->
  <div class="text-center">
    <h2 class="font-bold">Opponent: <span id="topName">Waiting...</span></h2>
    <p>Status: <span id="topStatus">-</span></p>
    <p>Score: <span id="topScore">0</span></p>
    <div id="opponentHand" class="relative h-32 mt-3"></div>
  </div>

  <!-- CENTER -->
  <div class="bg-white p-6 rounded shadow w-full max-w-xl text-center">

    <!-- GAME RESULT -->
    <div id="gameResult" class="hidden mb-3 p-3 rounded-lg text-xl font-bold"></div>

    <h2 class="font-bold mb-1">Center Pile</h2>
    <p class="text-sm mb-2">
      Trump: <span id="trumpSuit" class="font-bold">-</span>
    </p>

    <div id="centerMessage" class="h-8 mb-2"></div>

    <div id="cards" class="relative h-44 flex justify-center items-center"></div>
  </div>

  <!-- BOTTOM PLAYER -->
  <div class="text-center">
    <h2 class="font-bold">You: <span id="bottomName">Loading...</span></h2>
    <p>Status: <span id="bottomStatus">-</span></p>
    <p>Score: <span id="bottomScore">0</span></p>
    <div id="hand" class="relative h-40 mt-4"></div>
  </div>

<script>
const socket = io({ withCredentials: true });

const roomId = window.location.pathname.split("/").pop();
const userId = "<%= user._id %>";

socket.emit("joinRoom", { roomId, userId });

let lastCenterCount = 0;

/* =====================
   UI HELPERS
===================== */

function showCenterMessage(text, color) {
  const el = document.getElementById("centerMessage");
  el.innerHTML = `<div class="font-bold text-${color}-600 animate-pulse">${text}</div>`;
  setTimeout(() => el.innerHTML = "", 1200);
}

function renderGameResult(room) {
  const el = document.getElementById("gameResult");

  if (room.status !== "finished") {
    el.classList.add("hidden");
    return;
  }

  el.classList.remove("hidden");

  if (room.isDraw) {
    el.className =
      "mb-3 p-3 rounded-lg text-xl font-bold text-center bg-gray-200 text-gray-700";
    el.innerText = "ðŸ¤ Game Draw!";
  } else if (room.winner === userId) {
    el.className =
      "mb-3 p-3 rounded-lg text-xl font-bold text-center bg-green-200 text-green-700";
    el.innerText = "ðŸŽ‰ You WON the game!";
  } else {
    el.className =
      "mb-3 p-3 rounded-lg text-xl font-bold text-center bg-red-200 text-red-700";
    el.innerText = "ðŸ˜¢ You LOST the game";
  }
}

function renderCard(card, disabled = false, isBack = false) {
  const el = document.createElement("div");
  el.className = `
    w-24 h-36 rounded-lg border shadow-lg
    flex items-center justify-center
    font-bold text-xl bg-white
    ${disabled ? "opacity-60" : "hover:-translate-y-3 cursor-pointer"}
  `;

  if (isBack) {
    el.classList.add("bg-blue-600", "text-white");
    el.innerText = "ðŸ‚ ";
  } else {
    el.innerText = `${card.rank}${card.suit}`;
  }
  return el;
}

/* =====================
   ROOM STATE
===================== */

socket.on("roomState", (room) => {

  renderGameResult(room);

  const players = room.players || [];
  const me = players.find(p => p.userId === userId) || {};
  const opponent = players.find(p => p.userId !== userId) || {};

  document.getElementById("topName").innerText = opponent.name || "Waiting";
  document.getElementById("topStatus").innerText = opponent.status || "-";
  document.getElementById("topScore").innerText = opponent.score || 0;

  document.getElementById("bottomName").innerText = me.name || "You";
  document.getElementById("bottomStatus").innerText = me.status || "-";
  document.getElementById("bottomScore").innerText = me.score || 0;

  document.getElementById("trumpSuit").innerText = room.trumpSuit || "-";

  /* CENTER PILE */
  const cardsDiv = document.getElementById("cards");
  cardsDiv.innerHTML = "";

  room.centerPile.forEach((entry, i) => {
    const card = entry.card || entry;
    const playedBy = entry.playedBy;

    const cardEl = renderCard(card, true);
    cardEl.style.position = "absolute";
    cardEl.style.transform = `translateX(${i * 30}px)`;
    cardEl.style.zIndex = i;

    if (room.status === "playing" && i >= lastCenterCount) {
      cardEl.classList.add(
        playedBy === userId ? "throw-bottom" : "throw-top"
      );
    }

    cardsDiv.appendChild(cardEl);
  });

  lastCenterCount = room.centerPile.length;

  /* PLAYER HAND */
  const handDiv = document.getElementById("hand");
  handDiv.innerHTML = "";

  const myTurn = room.status === "playing" && room.turn === userId;

  me.hand?.forEach((card, i) => {
    const cardEl = renderCard(card, !myTurn);
    cardEl.style.position = "absolute";
    cardEl.style.left = `${i * 45}px`;
    cardEl.style.zIndex = i;

    if (myTurn) {
      cardEl.onclick = () =>
        socket.emit("playCard", { roomId, userId, card });
    }

    handDiv.appendChild(cardEl);
  });

  /* OPPONENT HAND */
  const oppHand = document.getElementById("opponentHand");
  oppHand.innerHTML = "";

  opponent.hand?.forEach((_, i) => {
    const back = renderCard({}, true, true);
    back.style.position = "absolute";
    back.style.left = `${i * 30}px`;
    back.style.zIndex = i;
    oppHand.appendChild(back);
  });
});

/* =====================
   EVENTS
===================== */

socket.on("roundTie", () =>
  showCenterMessage("Tie! Replay round", "yellow")
);

socket.on("roundWin", ({ winnerId }) =>
  showCenterMessage(
    winnerId === userId ? "You won the round!" : "You lost the round",
    winnerId === userId ? "green" : "red"
  )
);

socket.on("gameOver", ({ winner, isDraw }) => {
  if (isDraw) showCenterMessage("Game Draw!", "gray");
  else showCenterMessage(
    winner === userId ? "You won the game ðŸŽ‰" : "You lost the game ðŸ˜¢",
    winner === userId ? "green" : "red"
  );
});
</script>

</body>
</html>
