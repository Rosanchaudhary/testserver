<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Card Game</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>

    <!-- MINIMAL REQUIRED CSS (Tailwind CDN limitation) -->
    <style>
      body {
        perspective: 1200px;
      }

      @keyframes throwFromBottom {
        from {
          transform: translateY(160px) scale(1.05);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      @keyframes throwFromTop {
        from {
          transform: translateY(-160px) scale(1.05);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .throw-bottom {
        animation: throwFromBottom 0.3s ease-out;
      }
      .throw-top {
        animation: throwFromTop 0.3s ease-out;
      }
    </style>
  </head>

  <body
    class="bg-green-700 min-h-screen flex flex-col justify-between items-center p-6 text-white"
  >
    <!-- TOP PLAYER -->
    <div class="text-center">
      <h2 class="font-bold">
        Opponent: <span id="topName">Waiting...</span>
      </h2>
      <p>Status: <span id="topStatus">-</span></p>
      <p>Score: <span id="topScore">0</span></p>
      <div id="opponentHand" class="relative h-32 mt-3"></div>
    </div>

    <!-- CENTER -->
    <div class="p-6 w-full max-w-xl text-center">
      <div
        id="gameResult"
        class="hidden mb-3 p-3 rounded-lg text-xl font-bold"
      ></div>

      <h2 class="font-bold mb-1">Center Pile</h2>
      <p class="text-sm mb-2">
        Trump: <span id="trumpSuit" class="font-bold">-</span>
      </p>

      <div id="centerMessage" class="h-8 mb-2"></div>

      <div
        id="cards"
        class="relative h-44 flex justify-center items-center"
      ></div>
    </div>

    <!-- BOTTOM PLAYER -->
    <div class="text-center">
      <h2 class="font-bold">You: <span id="bottomName">Loading...</span></h2>
      <p>Status: <span id="bottomStatus">-</span></p>
      <p>Score: <span id="bottomScore">0</span></p>
      <div id="hand" class="relative h-40 mt-4 overflow-visible"></div>
    </div>

    <script>
      const socket = io({ withCredentials: true });

      const roomId = window.location.pathname.split("/").pop();
      const userId = "<%= user._id %>";

      socket.emit("joinTwoCardRoom", { roomId, userId });

      let lastCenterCount = 0;

      function showCenterMessage(text, color) {
        const el = document.getElementById("centerMessage");
        el.innerHTML = `<div class="font-bold text-${color}-300 animate-pulse">${text}</div>`;
        setTimeout(() => (el.innerHTML = ""), 1200);
      }

      function renderGameResult(room) {
        const el = document.getElementById("gameResult");

        if (room.status !== "finished") {
          el.classList.add("hidden");
          return;
        }

        el.classList.remove("hidden");

        if (room.isDraw) {
          el.className =
            "mb-3 p-3 rounded-lg text-xl font-bold bg-gray-200 text-gray-700";
          el.innerText = "ü§ù Game Draw!";
        } else if (room.winner === userId) {
          el.className =
            "mb-3 p-3 rounded-lg text-xl font-bold bg-green-200 text-green-700";
          el.innerText = "üéâ You WON the game!";
        } else {
          el.className =
            "mb-3 p-3 rounded-lg text-xl font-bold bg-red-200 text-red-700";
          el.innerText = "üò¢ You LOST the game";
        }
      }

      /* =====================
         CARD RENDER (TAILWIND)
      ===================== */

      function renderCard(card, disabled = false, isBack = false) {
        const wrapper = document.createElement("div");
        wrapper.className = "absolute z-10 hover:z-50";

        const inner = document.createElement("div");
        inner.className = `
          w-24 h-36
          rounded-lg
          border border-black
          flex items-center justify-center
          font-bold text-xl
          relative
          transition-all duration-200
          ${
            disabled
              ? "opacity-60"
              : "cursor-pointer hover:-translate-y-3 hover:shadow-2xl"
          }
        `;

        /* CARD BACK */
        if (isBack) {
          inner.className += `
            bg-red-900
            text-white
            border-2 border-red-300
            shadow-lg
          `;

          const emblem = document.createElement("div");
          emblem.className = "text-3xl select-none";
          emblem.innerText = "‚ô†";

          inner.appendChild(emblem);
          wrapper.appendChild(inner);
          return wrapper;
        }

        /* CARD FRONT */
        inner.className += `
          bg-gradient-to-br from-white to-slate-100
          shadow-lg
        `;

        const isRed = card.suit === "‚ô•" || card.suit === "‚ô¶";
        inner.className += isRed ? " text-red-600" : " text-slate-900";

        const top = document.createElement("div");
        top.className = "absolute top-1 left-1 text-sm leading-tight";
        top.innerHTML = `<div>${card.rank}</div><div>${card.suit}</div>`;

        const bottom = document.createElement("div");
        bottom.className =
          "absolute bottom-1 right-1 text-sm leading-tight rotate-180";
        bottom.innerHTML = `<div>${card.rank}</div><div>${card.suit}</div>`;

        const center = document.createElement("div");
        center.className = "text-4xl select-none";
        center.innerText = card.suit;

        inner.append(top, center, bottom);
        wrapper.appendChild(inner);
        return wrapper;
      }

      /* =====================
         ROOM STATE
      ===================== */

      socket.on("twoCardRoomState", (room) => {
        renderGameResult(room);

        const players = room.players || [];
        const me = players.find((p) => p.userId === userId) || {};
        const opponent = players.find((p) => p.userId !== userId) || {};

        document.getElementById("topName").innerText =
          opponent.name || "Waiting";
        document.getElementById("topStatus").innerText = opponent.status || "-";
        document.getElementById("topScore").innerText = opponent.score || 0;

        document.getElementById("bottomName").innerText = me.name || "You";
        document.getElementById("bottomStatus").innerText = me.status || "-";
        document.getElementById("bottomScore").innerText = me.score || 0;

        document.getElementById("trumpSuit").innerText = room.trumpSuit || "-";

        /* CENTER PILE */
        const cardsDiv = document.getElementById("cards");
        cardsDiv.innerHTML = "";

        room.centerPile.forEach((entry, i) => {
          const card = entry.card || entry;
          const cardEl = renderCard(card, true);

          cardEl.style.transform = `translateX(${i * 30}px)`;
          cardEl.style.zIndex = i;

          if (room.status === "playing" && i >= lastCenterCount) {
            cardEl.classList.add(
              entry.playedBy === userId ? "throw-bottom" : "throw-top"
            );
          }

          cardsDiv.appendChild(cardEl);
        });

        lastCenterCount = room.centerPile.length;

        /* PLAYER HAND */
        const handDiv = document.getElementById("hand");
        handDiv.innerHTML = "";

        const myTurn = room.status === "playing" && room.turn === userId;

        me.hand?.forEach((card, i) => {
          const cardEl = renderCard(card, !myTurn);

          cardEl.style.left = `${i * 45}px`;
          cardEl.style.zIndex = i;

          if (myTurn) {
            cardEl.onclick = () =>
              socket.emit("playTwoCard", { roomId, userId, card });
          }

          handDiv.appendChild(cardEl);
        });

        /* OPPONENT HAND */
        const oppHand = document.getElementById("opponentHand");
        oppHand.innerHTML = "";

        Array.from({ length: opponent.handCount || 0 }).forEach((_, i) => {
          const back = renderCard({}, true, true);
          back.style.left = `${i * 30}px`;
          back.style.zIndex = i;
          oppHand.appendChild(back);
        });
      });
    </script>
  </body>
</html>
